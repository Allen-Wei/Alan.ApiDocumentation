<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" ng-app="ApiDocApp">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>接口</title>
    <link href="styles/bootstrap.css" rel="stylesheet" />
    <script src="scripts/angular-1.3.15/angular.js"></script>
    <script src="scripts/angular-1.3.15/angular-route.js"></script>
    <!-- #region templates -->

    <script type="text/ng-template" id="apidetail.html">
        <style type="text/css">
            .api-table > tbody > tr > td:first-child { width: 120px; text-align: right; }
            .btn-toggle:hover { opacity: .95; }
            .slide-toggle { cursor: pointer; }
        </style>

        <div class="panel panel-default">
            <div class="panel-heading">
                资源描述
            </div>
            <div class="panel-body">
                <div title="Summary">
                    描述: {{main.controller.Summary}}
                </div>
                <hr />

                <div class="Permission" ng-show="main.controller.Permission">
                    权限: {{main.controller.Permission}}
                </div>
                <hr ng-show="main.controller.Permission" />

                <div title="Note" ng-show="main.controller.Note">
                    备注: {{main.controller.Note}}
                </div>
                <hr ng-show="main.controller.Note" />

                <div title="Example" ng-show="main.controller.Example">
                    例子:
                    <pre>
{{main.controller.Example}}
</pre>
                </div>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                测试接口
            </div>
            <div class="panel-body">
                <div class="input-group">
                    <span class="input-group-addon">接口选择</span>
                    <select class="form-control" ng-model="main.apiTest.selectedIndex">
                        <option ng-repeat="api in main.apis" cms-tooltips title="{{api.DocDescription.Summary}}" value="{{$index}}">{{api.HttpMethod}} - {{api.RelativePath}} - {{api.DocDescription.Summary}}</option>
                    </select>
                </div>
                <br />
                <div class="input-group">
                    <span class="input-group-addon">Url 参数</span>
                    <input ng-model="main.apiTest.urlParams" type="text" class="form-control" placeholder="在这里输入URL参数, 比如 para1=value1&para2=value2." />
                </div>
                <br />
                <div class="input-group">
                    <span class="input-group-addon">Body数据</span>
                    <input ng-model="main.apiTest.body" type="text" class="form-control" placeholder='在这里输入Body的JSON 数据, Key和类型为string的value要使用双引号包裹, 比如{"Name":"Alan", Age: 25}.' />
                </div>
                <br />
                <button class="btn btn-default" ng-click="main.apiTest.send()">测试</button>
                <hr ng-show="main.apiTest.result" />
                <div class="panel panel-default" ng-show="main.apiTest.result">
                    <div class="panel-heading">
                        测试结果
                        <i class="glyphicon glyphicon-chevron-down slide-toggle pull-right"></i>
                    </div>
                    <div class="panel-body api-collapse">
                        <pre ng-show="main.apiTest.result">
{{main.apiTest.result}}
                </pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel panel-default" ng-repeat="api in main.apis">
            <div class="panel-heading" ng-click="api.collapse = !api.collapse">
                <i class="glyphicon" ng-class="{'glyphicon-phone': api.DocDescription.Remarks == 'Mobile', 'glyphicon-filter': api.DocDescription.Remarks != 'Mobile'}"></i>
                {{api.HttpMethod}}
                {{api.RelativePath}}
                {{api.DocDescription.Summary}}
                <i class="glyphicon glyphicon-chevron-down slide-toggle pull-right"></i>
            </div>

            <table class="table table-bordered api-table api-collapse" ng-hide="api.collapse">
                <tbody>
                    <tr>
                        <td>描述</td>
                        <td>{{api.DocDescription.Summary}}</td>
                    </tr>
                    <tr>
                        <td>HTTP Method</td>
                        <td>{{api.HttpMethod}}</td>
                    </tr>
                    <tr>
                        <td>接口地址</td>
                        <td>{{api.RelativePath}}</td>
                    </tr>
                    <tr>
                        <td>返回</td>
                        <td> <pre>{{api.DocDescription.Returns}}</pre> </td>
                    </tr>
                    <tr ng-show="api.DocDescription.Example">
                        <td>例子</td>
                        <td><pre>{{api.DocDescription.Example}}</pre></td>
                    </tr>
                    <tr ng-show="api.DocDescription.Remark">
                        <td>标记</td>
                        <td>{{api.DocDescription.Remark}}</td>
                    </tr>
                    <tr ng-show="api.DocDescription.Permission">
                        <td>权限</td>
                        <td>{{api.DocDescription.Permission}}</td>
                    </tr>
                    <tr ng-show="api.DocDescription.Note">
                        <td>备注</td>
                        <td>{{api.DocDescription.Note}}</td>
                    </tr>
                    <tr>
                        <td>参数</td>
                        <td>
                            <div class="panel panel-default" ng-repeat="para in api.Parameters" ng-show="api.Parameters.length > 0">
                                <div class="panel-heading" cms-tooltips title="{{para.Format}}">
                                    <b>
                                        {{para.Name}}
                                    </b>
                                    <i>{{para.TypeName}}</i>
                                    <i class="glyphicon glyphicon-chevron-down slide-toggle pull-right"></i>
                                </div>

                                <table class="table table-bordered para-table api-collapse">
                                    <tbody>
                                        <tr>
                                            <td>名称</td>
                                            <td>{{para.Name}}</td>
                                        </tr>
                                        <tr>
                                            <td>类型</td>
                                            <td>{{para.TypeName}}</td>
                                        </tr>
                                        <tr>
                                            <td>来源</td>
                                            <td>{{para.Source}}</td>
                                        </tr>
                                        <tr>
                                            <td>Comment</td>
                                            <td>
                                                <pre>{{para.DocMemPara.Comment}}</pre>
                                            </td>
                                        </tr>
                                        <tr title="{{para.Format}}" ng-show="para.DocMemPara.Example">
                                            <td>例子</td>
                                            <td>{{para.DocMemPara.Example}}</td>
                                        </tr>
                                        <tr ng-show="para.DocMemPara.Note">
                                            <td>备注</td>
                                            <td>{{para.DocMemPara.Note}}</td>
                                        </tr>
                                        <tr ng-show="para.DocMemPara.IsRequire">
                                            <td>是否必须</td>
                                            <td>{{para.DocMemPara.IsRequire}}</td>
                                        </tr>
                                        <tr ng-show="para.DocMemPara.DefaultValue">
                                            <td>默认值</td>
                                            <td>{{para.DocMemPara.DefaultValue}}</td>
                                        </tr>
                                    </tbody>
                                </table>


                            </div>


                            <span ng-show="api.Parameters.length <= 0">没有参数</span>
                        </td>
                    </tr>

                </tbody>
            </table>
        </div>


    </script>

    <!-- #endregion-->

    <style type="text/css">
        * { font-family: 'Microsoft YaHei', sans-serif; }
        .list-group-item.active, .list-group-item.active:hover, .list-group-item.active:focus { z-index: 2; color: #fff; background-color: #0094ff; border-color: #0094ef; }
        li.active a { color: white; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-12">
                <h3>API Document</h3>
            </div>
        </div>
        <div class="row" ng-controller="BodyCtrl">
            <div class="col-md-3 col-sm-12" ng-controller="NavigationCtrl">
                <ul class="list-group">
                    <li class="list-group-item" ng-repeat="nav in navigations" ng-class="{active: nav.active}">
                        <a href="{{nav.path}}">{{nav.name}}</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-9 col-sm-12">
                <div ng-view></div>
            </div>
        </div>


    </div>


    <script>
        var app = angular.module('ApiDocApp', ['ngRoute']);

        app.factory('ApiQuerySvc', function ($http, $q) {
            var _apis = [];
            var service = {
                getStatus: function () {
                    return $http({
                        method: 'get',
                        url: '/Api/v1/ApiDocumentation?action=status'
                    });
                },
                getControllers: function () {
                    return this.getAll();
                },
                getAll: function () {
                    var defer = $q.defer();
                    if (_apis.length <= 0) {
                        $http({
                            method: 'get',
                            url: '/Api/v1/ApiDocumentation'
                        }).then(function (rep) {
                            var data = rep.data || [];
                            _apis = data;

                            for (var i = 0; i < _apis.length; i++) {
                                var ctrl = _apis[i];
                                if (ctrl && ctrl.controller && ctrl.controller.Name) {
                                    var temporaryCtrlNames = ctrl.controller.Name.split('.');
                                    ctrl.controller.ControllerName = temporaryCtrlNames[temporaryCtrlNames.length - 1].replace('Controller', '');
                                } else {
                                    console.log('invalid controller name: ', ctrl);
                                }
                            }

                            defer.resolve(_apis);
                        }, function () {
                            defer.reject();
                        });
                    } else {
                        defer.resolve(_apis);
                    }

                    return defer.promise;
                },
                getApisByController: function (apiId) {
                    var defer = $q.defer();

                    var filter = function () {
                        var matchedApi = undefined;
                        for (var i = 0; i < _apis.length; i++) {
                            if (!_apis[i] || !_apis[i].controller) {
                                console.error("找不到Controller: ", _apis[i]);
                                continue;
                            }
                            if (_apis[i].controller.ControllerName === apiId) {
                                matchedApi = _apis[i];
                                break;
                            }
                        }
                        if (matchedApi) {
                            defer.resolve(matchedApi);
                        } else {
                            defer.reject();
                        }
                    }

                    this.getAll().then(filter, filter);

                    return defer.promise;
                }
            };
            return service;
        });

        app.config(function ($routeProvider) {
            $routeProvider.when("/", {
                controller: "HomeCtrl",
                template:"<h1>Hello</h1>"
            }).when('/api/:id', {
                controller: 'ApiDetailCtrl',
                templateUrl: 'apidetail.html'
            }).otherwise({
                redirectTo: '/'
            });
        });

        app.controller('BodyCtrl', function ($scope) {

        });

        app.controller("HomeCtrl", function ($scope) {

        });

        app.controller('NavigationCtrl', function ($scope, $rootScope, ApiQuerySvc) {
            var navs = $scope.navigations = [{
                name: 'API Documetation',
                path: '#/guid',
                active: false
            }, {
                name: '返回结果描述',
                path: '#/status',
                active: false
            }, {
                name: '网站目录结构',
                path: '#/site',
                active: false
            }];

            ApiQuerySvc.getControllers().then(function (data) {

                var controllers = data;

                for (var i = 0; i < controllers.length; i++) {
                    var ctrl = controllers[i];
                    try {
                        navs.push({
                            name: ctrl.controller.ControllerName + '-' + ctrl.controller.Summary,
                            path: '#/api/' + ctrl.controller.ControllerName,
                            active: false
                        });
                    } catch (ex) {
                        console.info(ctrl);
                        console.error(ex);
                    }
                }
                $rootScope.$emit('$routeChangeSuccess');
            });


            $rootScope.$on('$routeChangeSuccess', function (e, newPath, previousPath) {
                for (var i = 0; i < navs.length; i++) {
                    if (navs[i].path.toLowerCase() === location.hash.toLowerCase()) {
                        navs[i].active = true;
                        document.title = navs[i].name;
                    } else {
                        navs[i].active = false;
                    }
                }
            });

        });

        app.controller('ApiDetailCtrl', function ($scope, ApiQuerySvc, $routeParams, $http) {
            $scope.main = {
                apis: [],
                controller: {},
                apiTest: {
                    urlParams: '',
                    body: '',
                    result: '',
                    selectedIndex: 0,
                    selected: function () {
                        return $scope.main.apis[this.selectedIndex];
                    },
                    send: function () {
                        var scope = this;

                        var api = scope.selected();
                        if (!api) {
                            alert('接口选择错误');
                            return;
                        }

                        var url = api.RelativePath || '';
                        //替换URL参数
                        if (scope.urlParams) {
                            var params = scope.urlParams;
                            params = params.split('&');
                            for (var i = 0; i < params.length; i++) {
                                var para = params[i];
                                var placeholder = '{' + para.split('=')[0] + '}';
                                var value = para.split('=')[1];
                                url = url.replace(placeholder, value);
                            }
                        }

                        var bodyData = undefined;
                        try {
                            if (scope.body) {
                                bodyData = JSON.parse(scope.body);
                            }
                        } catch (ex) {
                            alert('Body不是有效的JSON数据.(JSON的Key和类型为字符串的Value必须有双引号包裹)', ex.message);
                            return;
                        }

                        $http({
                            method: api.HttpMethod,
                            url: '/' + url,
                            data: bodyData
                        }).then(function (rep) {
                            scope.result = JSON.stringify(rep.data, null, 2);
                        }, function (rep) {
                            scope.result = {
                                status: rep.status,
                                statusText: rep.statusText
                            };
                        });
                    }
                }
            };
            var controllerName = $routeParams.id;

            ApiQuerySvc.getApisByController(controllerName).then(function (data) {
                var apisData = data.apis;

                for (var i = 0; i < apisData.length; i++) {
                    apisData[i].collapse = true;
                }
                if (apisData.sort) {
                    apisData.sort(function (pre, next) {
                        pre.DocDescription.Remarks = pre.DocDescription.Remarks || "PC";
                        next.DocDescription.Remarks = next.DocDescription.Remarks || "PC";
                        return next.DocDescription.Remarks === "PC" ? -1 : 1;
                    });
                }
                $scope.main.apis = apisData;
                $scope.main.controller = data.controller;
            });
        });

    </script>

</body>
</html>
